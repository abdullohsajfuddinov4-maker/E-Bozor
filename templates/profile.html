{% extends "base.html" %}

{% block title %}
E-Bazar - {{ customuser.username }}
{% endblock title %}

{% block content %}

<div class="container mt-5">
    <div class="row">
        <div class="col-lg-{% if customuser == request.user %}8{% else %}12{% endif %}">
            <div class="card shadow-sm p-4">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <img class="img-thumbnail rounded-circle"
                             width="150"
                             height="150"
                             src="{{ customuser.avatar.url|default:'/static/images/default-avatar.png' }}"
                             style="object-fit: cover;"
                             alt="profile image">
                    </div>

                    <div class="col-md-9">
                        <h2>{{ customuser.get_full_name }}</h2>
                        <p class="text-muted">@{{ customuser.username }}</p>

                        {% if customuser == request.user %}
                            <div class="mb-3">
                                <a class="btn btn-warning btn-sm" href="{% url 'users:update' %}">
                                    Edit details
                                </a>
                                <a class="btn btn-danger btn-sm" href="{% url 'password_change' %}">
                                    Update Password
                                </a>
                            </div>
                        {% endif %}

                        <div class="mt-3">
                            <p><strong>Email:</strong> {{ customuser.email }}</p>
                            <p><strong>Call:</strong> {{ customuser.phone_number }}</p>
                            <p><strong>Telegram:</strong> @{{ customuser.tg_username }}</p>
                        </div>

                        {% if request.user != customuser %}
                            <div class="mt-3">
                                <a href="{% url 'users:chat_detail' customuser.id %}"
                                   class="btn btn-primary w-100">
                                    <i class="bi bi-chat-dots"></i> Message
                                </a>
                            </div>
                        {% endif %}
                    </div>


                </div>
            </div>
        </div>

        {% if customuser == request.user %}
        <div class="col-lg-4">
            <div class="card shadow-sm p-3">
                <h6 class="text-center mb-3">My notes (Private)</h6>
                <div id="calendar"></div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="container mt-5">
    <h4>Products of @{{ customuser.username }}</h4>
    <hr>

    <div class="row">
        {% for product in customuser.product_set.all %}
            <div class="col-md-3 mb-4">
                <div class="card h-100 border-0 shadow-sm">
                    {% with first_image=product.images.all.first %}
                        {% if first_image %}
                            <img src="{{ first_image.image.url }}" class="card-img-top" height="200" style="object-fit: cover;">
                        {% else %}
                            <img src="/static/images/default-product.png" class="card-img-top" height="200" style="object-fit: cover;">
                        {% endif %}
                    {% endwith %}

                    <div class="card-body">
                        <h6 class="card-title text-truncate">{{ product.title }}</h6>
                        <p class="text-success fw-bold mb-2">${{ product.price }}</p>
                        <a href="{% url 'products:detail' product.id %}" class="btn btn-outline-primary btn-sm w-100">Details</a>
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="col-12">
                <p class="text-muted text-center">This user has no products yet.</p>
            </div>
        {% endfor %}
    </div>
</div>

{% if customuser == request.user %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 360,
        headerToolbar: { left: 'prev', center: 'title', right: 'next' },
        events: [
            {% for r in reminders %}
            { title: "{{ r.title|escapejs }}", start: "{{ r.date }}", allDay: true },
            {% endfor %}
        ],
        dateClick: function (info) {
            const title = prompt('Add reminder for ' + info.dateStr);
            if (!title) return;
            fetch("{% url 'users:profile' customuser.username %}", {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ date: info.dateStr, title: title })
            }).then(() => {
                calendar.addEvent({ title: title, start: info.dateStr, allDay: true });
            });
        }
    });
    calendar.render();
});
</script>
{% endif %}

{% endblock content %}
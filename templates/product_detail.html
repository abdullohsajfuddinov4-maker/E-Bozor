{% extends "base.html" %}

{% block title %}
E-Bazar - {{ product.title }}
{% endblock title %}

{% block content %}
<div class="container mt-5">

    <!-- PRODUCT -->
    <div class="row shadow-sm">
        <div class="col-4 p-3">
            <div id="carouselExample" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner">
                    {% for picture in product.productimage_set.all %}
                        <div class="carousel-item {% if forloop.first %}active{% endif %}">
                            <img class="d-block w-100" height="270" src="{{ picture.image.url }}">
                        </div>
                    {% endfor %}
                </div>

                <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon"></span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
                    <span class="carousel-control-next-icon"></span>
                </button>
            </div>
        </div>

        <div class="col-7 p-5">
            <h4>{{ product.title }}</h4>

            <p class="text-muted">
                <a href="{% url 'users:profile' product.author.username %}">
                    @{{ product.author.username }}
                </a>
                | {{ product.date|date:"d.m.Y" }}
            </p>

            <p>{{ product.description|safe }}</p>

            <!-- RATING -->
            <p>
                ⭐ Средний рейтинг:
                <strong>{{ product.average_rating|floatformat:1 }}</strong> / 5
            </p>

            <div class="mt-4">
                {% if request.user == product.author %}
                    <a class="btn btn-warning" href="{% url 'products:update' product.id %}">
                        Edit
                    </a>

                    <form action="{% url 'products:delete' product.id %}"
                          method="post"
                          class="d-inline"
                          onsubmit="return confirm('Вы действительно хотите удалить этот продукт?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">
                            Delete
                        </button>
                    </form>
                {% endif %}


                <a class="btn btn-primary" href="mailto:{{ product.author.email }}">Email</a>
                <a class="btn btn-primary" href="tel:{{ product.phone_number }}">Call</a>
                <a class="btn btn-primary" href="https://t.me/{{ product.tg_username }}">Telegram</a>
            </div>
        </div>
    </div>

    <!-- COMMENTS -->
   <div class="row mt-5">
    <div class="col-8">
        <h5>Add comment</h5>

        <form action="{% url 'products:comment_new' product.id %}" method="post">
            {% csrf_token %}

            <div class="mb-2">
                <select name="rating" class="form-select" required>
                    <option value="">Rating</option>
                    {% for i in "12345" %}
                        <option value="{{ i }}">{{ i }} ⭐</option>
                    {% endfor %}
                </select>
            </div>

            <div class="input-group">
                <input class="form-control" name="body" required placeholder="Your comment">
                <button class="btn btn-success">Send</button>
            </div>
        </form>

        <hr>

        <h6>Comments</h6>

        {% for comment in product.comments.all %}
            <div class="mb-3 d-flex align-items-start">
                <!-- Фото профиля автора -->
                <div class="me-3">
                    <img src="{{ comment.author.avatar.url|default:'/static/images/default-avatar.png' }}"
                         class="rounded-circle"
                         width="40"
                         height="40"
                         alt="{{ comment.author.get_full_name }} avatar">
                </div>

                <!-- Текст комментария и метаданные -->
                <div class="flex-grow-1">
                    <small class="text-muted d-block mb-1">
                        @{{ comment.author.username }}
                        | {{ comment.date }}
                        | ⭐ {{ comment.rating }}/5
                    </small>

                    <p class="mb-0">
                        {{ comment.body }}

                        {% if request.user == comment.author %}
                            <a class="text-danger ms-2"
                               href="{% url 'products:comment_delete' product.id comment.id %}"
                               onclick="return confirm('Вы действительно хотите удалить этот комментарий?');">
                                delete
                            </a>
                        {% endif %}
                    </p>
                </div>
            </div>
        {% empty %}
            <p class="text-muted">No comments yet</p>
        {% endfor %}
    </div>
</div>


</div>
{% endblock content %}
